"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.COMMAND_TYPES = exports.AndroidBootstrap = void 0;
require("source-map-support/register");
var _uiautomator = _interopRequireDefault(require("./uiautomator"));
var _net = _interopRequireDefault(require("net"));
var _path = _interopRequireDefault(require("path"));
var _lodash = _interopRequireDefault(require("lodash"));
var _driver = require("appium/driver");
var _bluebird = _interopRequireDefault(require("bluebird"));
var _support = require("appium/support");
const log = _support.logger.getLogger('AndroidBootstrap');
const COMMAND_TYPES = {
  ACTION: 'action',
  SHUTDOWN: 'shutdown'
};
exports.COMMAND_TYPES = COMMAND_TYPES;
const SEND_COMMAND_TIMEOUT = 1 * 60 * 1000;

const getModuleRoot = _lodash.default.memoize(async function getModuleRoot() {
  let currentDir = _path.default.dirname(_path.default.resolve(__filename));
  let isAtFsRoot = false;
  while (!isAtFsRoot) {
    const manifestPath = _path.default.join(currentDir, 'package.json');
    try {
      if ((await _support.fs.exists(manifestPath)) && JSON.parse(await _support.fs.readFile(manifestPath, 'utf8')).name === 'appium-android-driver') {
        return currentDir;
      }
    } catch (ign) {}
    currentDir = _path.default.dirname(currentDir);
    isAtFsRoot = currentDir.length <= _path.default.dirname(currentDir).length;
  }
  throw new Error('Cannot find the root folder of the appium-android-driver Node.js module');
});
class AndroidBootstrap {
  constructor(adb, systemPort = 4724, webSocket = undefined) {
    this.adb = adb;
    this.systemPort = systemPort;
    this.webSocket = webSocket;
    this.ignoreUnexpectedShutdown = false;
  }
  get onUnexpectedShutdown() {
    if (!this._onUnexpectedShutdownPromise) {
      let reject;
      this._onUnexpectedShutdownPromise = new _bluebird.default(function _onUnexpectedShutdownPromise(_resolve, _reject) {
        reject = _reject;
      });
      this._onUnexpectedShutdownPromise.cancel = reject;
    }
    return this._onUnexpectedShutdownPromise;
  }
  async start(appPackage, disableAndroidWatchers = false, acceptSslCerts = false) {
    try {
      const startDetector = s => /Appium Socket Server Ready/.test(s);
      const bootstrapJar = _path.default.resolve(await getModuleRoot(), 'bootstrap', 'bin', 'AppiumBootstrap.jar');
      await this.init();
      await this.adb.forwardPort(this.systemPort, 4724);
      this.process = await this.uiAutomator.start(bootstrapJar, 'io.appium.android.bootstrap.Bootstrap', startDetector, '-e', 'pkg', appPackage, '-e', 'disableAndroidWatchers', disableAndroidWatchers, '-e', 'acceptSslCerts', acceptSslCerts);

      this.process.on('output', (stdout, stderr) => {
        const alertRe = /Emitting system alert message/;
        if (alertRe.test(stdout)) {
          log.debug('Emitting alert message...');
          if (this.webSocket) {
            this.webSocket.sockets.emit('alert', {
              message: stdout
            });
          }
        }

        let stdoutLines = (stdout || '').split('\n');
        const uiautoLog = /\[APPIUM-UIAUTO\](.+)\[\/APPIUM-UIAUTO\]/;
        for (let line of stdoutLines) {
          if (line.trim()) {
            if (uiautoLog.test(line)) {
              let innerLine = uiautoLog.exec(line)[1].trim();
              let logMethod = log.info.bind(log);
              if (/\[debug\]/.test(innerLine)) {
                logMethod = log.debug.bind(log);
              }
              logMethod(`[BOOTSTRAP LOG] ${innerLine}`);
            } else {
              log.debug(`[UIAUTO STDOUT] ${line}`);
            }
          }
        }
        let stderrLines = (stderr || '').split('\n');
        for (let line of stderrLines) {
          if (line.trim()) {
            log.debug(`[UIAUTO STDERR] ${line}`);
          }
        }
      });

      return await new _bluebird.default((resolve, reject) => {
        try {
          this.socketClient = _net.default.connect(this.systemPort);
          this.socketClient.on('error', err => {
            if (!this.ignoreUnexpectedShutdown) {
              throw new Error(`Android bootstrap socket crashed: ${err}`);
            }
          });
          this.socketClient.once('connect', () => {
            log.info('Android bootstrap socket is now connected');
            resolve();
          });
        } catch (err) {
          reject(err);
        }
      });
    } catch (err) {
      log.errorAndThrow(`Error occured while starting AndroidBootstrap. Original error: ${err}`);
    }
  }
  async sendCommand(type, extra = {}) {
    if (!this.socketClient) {
      throw new Error('Socket connection closed unexpectedly');
    }
    return await new _bluebird.default((resolve, reject) => {
      let cmd = Object.assign({
        cmd: type
      }, extra);
      let cmdJson = `${JSON.stringify(cmd)} \n`;
      log.debug(`Sending command to android: ${_lodash.default.truncate(cmdJson, {
        length: 1000
      }).trim()}`);
      this.socketClient.write(cmdJson);
      this.socketClient.setEncoding('utf8');
      let streamData = '';
      let sendCommandTimeoutHandler = null;
      this.socketClient.on('data', data => {
        if (sendCommandTimeoutHandler) {
          clearTimeout(sendCommandTimeoutHandler);
        }
        log.debug('Received command result from bootstrap');
        try {
          streamData = JSON.parse(streamData + data);
          this.socketClient.removeAllListeners('data');
          if (streamData.status === 0) {
            return resolve(streamData.value);
          }
          reject((0, _driver.errorFromCode)(streamData.status, streamData.value));
        } catch (err) {
          if (!_lodash.default.isString(streamData)) {
            log.error('Got an unexpected error inside socket listener');
            log.error(err.stack);
            return reject((0, _driver.errorFromCode)(13, err.message));
          }
          log.debug(`Stream still not complete, waiting up to ${SEND_COMMAND_TIMEOUT}ms for the data to arrive`);
          streamData += data;
          sendCommandTimeoutHandler = setTimeout(() => {
            const errMsg = `Server socket stopped responding. The recent response was '${streamData}'`;
            log.error(errMsg);
            this.socketClient.removeAllListeners('data');
            reject((0, _driver.errorFromCode)(13, errMsg));
          }, SEND_COMMAND_TIMEOUT);
        }
      });
    });
  }
  async sendAction(action, params = {}) {
    let extra = {
      action,
      params
    };
    return await this.sendCommand(COMMAND_TYPES.ACTION, extra);
  }
  async shutdown() {
    if (!this.uiAutomator) {
      log.warn('Cannot shut down Android bootstrap; it has already shut down');
      return;
    }

    this.uiAutomator.removeAllListeners(_uiautomator.default.EVENT_CHANGED);
    if (this.socketClient) {
      await this.sendCommand(COMMAND_TYPES.SHUTDOWN);
    }
    await this.uiAutomator.shutdown();
    this.uiAutomator = null;
  }

  async init() {
    this.uiAutomator = new _uiautomator.default(this.adb);

    this.uiAutomator.on(_uiautomator.default.EVENT_CHANGED, msg => {
      if (msg.state === _uiautomator.default.STATE_STOPPED) {
        this.uiAutomator = null;
        this.onUnexpectedShutdown.cancel(new Error('UiAUtomator shut down unexpectedly'));
      }
    });
  }
  set ignoreUnexpectedShutdown(ignore) {
    log.debug(`${ignore ? 'Ignoring' : 'Watching for'} bootstrap disconnect`);
    this._ignoreUnexpectedShutdown = ignore;
  }
  get ignoreUnexpectedShutdown() {
    return this._ignoreUnexpectedShutdown;
  }
}
exports.AndroidBootstrap = AndroidBootstrap;
var _default = AndroidBootstrap;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJsb2ciLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJDT01NQU5EX1RZUEVTIiwiQUNUSU9OIiwiU0hVVERPV04iLCJTRU5EX0NPTU1BTkRfVElNRU9VVCIsImdldE1vZHVsZVJvb3QiLCJfIiwibWVtb2l6ZSIsImN1cnJlbnREaXIiLCJwYXRoIiwiZGlybmFtZSIsInJlc29sdmUiLCJfX2ZpbGVuYW1lIiwiaXNBdEZzUm9vdCIsIm1hbmlmZXN0UGF0aCIsImpvaW4iLCJmcyIsImV4aXN0cyIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlIiwibmFtZSIsImlnbiIsImxlbmd0aCIsIkVycm9yIiwiQW5kcm9pZEJvb3RzdHJhcCIsImNvbnN0cnVjdG9yIiwiYWRiIiwic3lzdGVtUG9ydCIsIndlYlNvY2tldCIsInVuZGVmaW5lZCIsImlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biIsIm9uVW5leHBlY3RlZFNodXRkb3duIiwiX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZSIsInJlamVjdCIsIkIiLCJfcmVzb2x2ZSIsIl9yZWplY3QiLCJjYW5jZWwiLCJzdGFydCIsImFwcFBhY2thZ2UiLCJkaXNhYmxlQW5kcm9pZFdhdGNoZXJzIiwiYWNjZXB0U3NsQ2VydHMiLCJzdGFydERldGVjdG9yIiwicyIsInRlc3QiLCJib290c3RyYXBKYXIiLCJpbml0IiwiZm9yd2FyZFBvcnQiLCJwcm9jZXNzIiwidWlBdXRvbWF0b3IiLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsImFsZXJ0UmUiLCJkZWJ1ZyIsInNvY2tldHMiLCJlbWl0IiwibWVzc2FnZSIsInN0ZG91dExpbmVzIiwic3BsaXQiLCJ1aWF1dG9Mb2ciLCJsaW5lIiwidHJpbSIsImlubmVyTGluZSIsImV4ZWMiLCJsb2dNZXRob2QiLCJpbmZvIiwiYmluZCIsInN0ZGVyckxpbmVzIiwic29ja2V0Q2xpZW50IiwibmV0IiwiY29ubmVjdCIsImVyciIsIm9uY2UiLCJlcnJvckFuZFRocm93Iiwic2VuZENvbW1hbmQiLCJ0eXBlIiwiZXh0cmEiLCJjbWQiLCJPYmplY3QiLCJhc3NpZ24iLCJjbWRKc29uIiwic3RyaW5naWZ5IiwidHJ1bmNhdGUiLCJ3cml0ZSIsInNldEVuY29kaW5nIiwic3RyZWFtRGF0YSIsInNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIiLCJkYXRhIiwiY2xlYXJUaW1lb3V0IiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwic3RhdHVzIiwidmFsdWUiLCJlcnJvckZyb21Db2RlIiwiaXNTdHJpbmciLCJlcnJvciIsInN0YWNrIiwic2V0VGltZW91dCIsImVyck1zZyIsInNlbmRBY3Rpb24iLCJhY3Rpb24iLCJwYXJhbXMiLCJzaHV0ZG93biIsIndhcm4iLCJVaUF1dG9tYXRvciIsIkVWRU5UX0NIQU5HRUQiLCJtc2ciLCJzdGF0ZSIsIlNUQVRFX1NUT1BQRUQiLCJpZ25vcmUiLCJfaWdub3JlVW5leHBlY3RlZFNodXRkb3duIl0sInNvdXJjZXMiOlsiLi4vLi4vbGliL2Jvb3RzdHJhcC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVWlBdXRvbWF0b3IgZnJvbSAnLi91aWF1dG9tYXRvcic7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvckZyb21Db2RlIH0gZnJvbSAnYXBwaXVtL2RyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIsIGZzIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuXG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0FuZHJvaWRCb290c3RyYXAnKTtcbmNvbnN0IENPTU1BTkRfVFlQRVMgPSB7XG4gIEFDVElPTjogJ2FjdGlvbicsXG4gIFNIVVRET1dOOiAnc2h1dGRvd24nXG59O1xuY29uc3QgU0VORF9DT01NQU5EX1RJTUVPVVQgPSAxICogNjAgKiAxMDAwO1xuXG4vKipcbiAqIENhbGN1bGF0ZXMgdGhlIHBhdGggdG8gdGhlIGN1cnJlbnQgbW9kdWxlJ3Mgcm9vdCBmb2xkZXJcbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZnVsbCBwYXRoIHRvIG1vZHVsZSByb290XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGN1cnJlbnQgbW9kdWxlIHJvb3QgZm9sZGVyIGNhbm5vdCBiZSBkZXRlcm1pbmVkXG4gKi9cbmNvbnN0IGdldE1vZHVsZVJvb3QgPSBfLm1lbW9pemUoYXN5bmMgZnVuY3Rpb24gZ2V0TW9kdWxlUm9vdCAoKSB7XG4gIGxldCBjdXJyZW50RGlyID0gcGF0aC5kaXJuYW1lKHBhdGgucmVzb2x2ZShfX2ZpbGVuYW1lKSk7XG4gIGxldCBpc0F0RnNSb290ID0gZmFsc2U7XG4gIHdoaWxlICghaXNBdEZzUm9vdCkge1xuICAgIGNvbnN0IG1hbmlmZXN0UGF0aCA9IHBhdGguam9pbihjdXJyZW50RGlyLCAncGFja2FnZS5qc29uJyk7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMobWFuaWZlc3RQYXRoKSAmJlxuICAgICAgICAgIEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUobWFuaWZlc3RQYXRoLCAndXRmOCcpKS5uYW1lID09PSAnYXBwaXVtLWFuZHJvaWQtZHJpdmVyJykge1xuICAgICAgICByZXR1cm4gY3VycmVudERpcjtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgY3VycmVudERpciA9IHBhdGguZGlybmFtZShjdXJyZW50RGlyKTtcbiAgICBpc0F0RnNSb290ID0gY3VycmVudERpci5sZW5ndGggPD0gcGF0aC5kaXJuYW1lKGN1cnJlbnREaXIpLmxlbmd0aDtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHRoZSByb290IGZvbGRlciBvZiB0aGUgYXBwaXVtLWFuZHJvaWQtZHJpdmVyIE5vZGUuanMgbW9kdWxlJyk7XG59KTtcblxuY2xhc3MgQW5kcm9pZEJvb3RzdHJhcCB7XG4gIGNvbnN0cnVjdG9yIChhZGIsIHN5c3RlbVBvcnQgPSA0NzI0LCB3ZWJTb2NrZXQgPSB1bmRlZmluZWQpIHtcbiAgICB0aGlzLmFkYiA9IGFkYjtcbiAgICB0aGlzLnN5c3RlbVBvcnQgPSBzeXN0ZW1Qb3J0O1xuICAgIHRoaXMud2ViU29ja2V0ID0gd2ViU29ja2V0O1xuICAgIHRoaXMuaWdub3JlVW5leHBlY3RlZFNodXRkb3duID0gZmFsc2U7XG4gIH1cblxuICBnZXQgb25VbmV4cGVjdGVkU2h1dGRvd24gKCkge1xuICAgIGlmICghdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlKSB7XG4gICAgICBsZXQgcmVqZWN0O1xuICAgICAgdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlID0gbmV3IEIoZnVuY3Rpb24gX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZSAoX3Jlc29sdmUsIF9yZWplY3QpIHtcbiAgICAgICAgcmVqZWN0ID0gX3JlamVjdDtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlLmNhbmNlbCA9IHJlamVjdDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0IChhcHBQYWNrYWdlLCBkaXNhYmxlQW5kcm9pZFdhdGNoZXJzID0gZmFsc2UsIGFjY2VwdFNzbENlcnRzID0gZmFsc2UpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhcnREZXRlY3RvciA9IChzKSA9PiAvQXBwaXVtIFNvY2tldCBTZXJ2ZXIgUmVhZHkvLnRlc3Qocyk7XG4gICAgICBjb25zdCBib290c3RyYXBKYXIgPSBwYXRoLnJlc29sdmUoYXdhaXQgZ2V0TW9kdWxlUm9vdCgpLCAnYm9vdHN0cmFwJywgJ2JpbicsICdBcHBpdW1Cb290c3RyYXAuamFyJyk7XG5cbiAgICAgIGF3YWl0IHRoaXMuaW5pdCgpO1xuICAgICAgYXdhaXQgdGhpcy5hZGIuZm9yd2FyZFBvcnQodGhpcy5zeXN0ZW1Qb3J0LCA0NzI0KTtcbiAgICAgIHRoaXMucHJvY2VzcyA9IGF3YWl0IHRoaXMudWlBdXRvbWF0b3Iuc3RhcnQoXG4gICAgICAgICAgICAgICAgICAgICAgIGJvb3RzdHJhcEphciwgJ2lvLmFwcGl1bS5hbmRyb2lkLmJvb3RzdHJhcC5Cb290c3RyYXAnLFxuICAgICAgICAgICAgICAgICAgICAgICBzdGFydERldGVjdG9yLCAnLWUnLCAncGtnJywgYXBwUGFja2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgJy1lJywgJ2Rpc2FibGVBbmRyb2lkV2F0Y2hlcnMnLCBkaXNhYmxlQW5kcm9pZFdhdGNoZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAnLWUnLCAnYWNjZXB0U3NsQ2VydHMnLCBhY2NlcHRTc2xDZXJ0cyk7XG5cbiAgICAgIC8vIHByb2Nlc3MgdGhlIG91dHB1dFxuICAgICAgdGhpcy5wcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgY29uc3QgYWxlcnRSZSA9IC9FbWl0dGluZyBzeXN0ZW0gYWxlcnQgbWVzc2FnZS87XG4gICAgICAgIGlmIChhbGVydFJlLnRlc3Qoc3Rkb3V0KSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZygnRW1pdHRpbmcgYWxlcnQgbWVzc2FnZS4uLicpO1xuICAgICAgICAgIGlmICh0aGlzLndlYlNvY2tldCkge1xuICAgICAgICAgICAgdGhpcy53ZWJTb2NrZXQuc29ja2V0cy5lbWl0KCdhbGVydCcsIHttZXNzYWdlOiBzdGRvdXR9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgYm9vdHN0cmFwIGxvZ2dlciB3cmFwcyBpdHMgb3duIGxvZyBsaW5lcyB3aXRoXG4gICAgICAgIC8vIFtBUFBJVU0tVUlBVVRPXSAuLi4gW0FQUElVTS1VSUFVVE9dXG4gICAgICAgIC8vIGFuZCBsZWF2ZXMgYWN0dWFsIFVpQXV0b21hdG9yIGxvZ3MgYXMgdGhleSBhcmVcbiAgICAgICAgbGV0IHN0ZG91dExpbmVzID0gKHN0ZG91dCB8fCAnJykuc3BsaXQoJ1xcbicpO1xuICAgICAgICBjb25zdCB1aWF1dG9Mb2cgPSAvXFxbQVBQSVVNLVVJQVVUT1xcXSguKylcXFtcXC9BUFBJVU0tVUlBVVRPXFxdLztcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBzdGRvdXRMaW5lcykge1xuICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSkge1xuICAgICAgICAgICAgaWYgKHVpYXV0b0xvZy50ZXN0KGxpbmUpKSB7XG4gICAgICAgICAgICAgIGxldCBpbm5lckxpbmUgPSB1aWF1dG9Mb2cuZXhlYyhsaW5lKVsxXS50cmltKCk7XG4gICAgICAgICAgICAgIGxldCBsb2dNZXRob2QgPSBsb2cuaW5mby5iaW5kKGxvZyk7XG4gICAgICAgICAgICAgIC8vIGlmIHRoZSBib290c3RyYXAgbG9nIGNvbnNpZGVycyBzb21ldGhpbmcgZGVidWcsIGxvZyB0aGF0IGFzXG4gICAgICAgICAgICAgIC8vIGRlYnVnIGFuZCBub3QgaW5mb1xuICAgICAgICAgICAgICBpZiAoL1xcW2RlYnVnXFxdLy50ZXN0KGlubmVyTGluZSkpIHtcbiAgICAgICAgICAgICAgICBsb2dNZXRob2QgPSBsb2cuZGVidWcuYmluZChsb2cpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGxvZ01ldGhvZChgW0JPT1RTVFJBUCBMT0ddICR7aW5uZXJMaW5lfWApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbG9nLmRlYnVnKGBbVUlBVVRPIFNURE9VVF0gJHtsaW5lfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzdGRlcnJMaW5lcyA9IChzdGRlcnIgfHwgJycpLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBzdGRlcnJMaW5lcykge1xuICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBbVUlBVVRPIFNUREVSUl0gJHtsaW5lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIC8vIG9ubHkgcmV0dXJuIHdoZW4gdGhlIHNvY2tldCBjbGllbnQgaGFzIGNvbm5lY3RlZFxuICAgICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudCA9IG5ldC5jb25uZWN0KHRoaXMuc3lzdGVtUG9ydCk7XG4gICAgICAgICAgLy8gV2luZG93czogdGhlIHNvY2tldCBlcnJvcnMgb3V0IHdoZW4gQURCIHJlc3RhcnRzLiBMZXQncyBjYXRjaCBpdCB0byBhdm9pZCBjcmFzaGluZy5cbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaWdub3JlVW5leHBlY3RlZFNodXRkb3duKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQW5kcm9pZCBib290c3RyYXAgc29ja2V0IGNyYXNoZWQ6ICR7ZXJyfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBsb2cuaW5mbygnQW5kcm9pZCBib290c3RyYXAgc29ja2V0IGlzIG5vdyBjb25uZWN0ZWQnKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYEVycm9yIG9jY3VyZWQgd2hpbGUgc3RhcnRpbmcgQW5kcm9pZEJvb3RzdHJhcC4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh0eXBlLCBleHRyYSA9IHt9KSB7XG4gICAgaWYgKCF0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgY29ubmVjdGlvbiBjbG9zZWQgdW5leHBlY3RlZGx5Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBjbWQgPSBPYmplY3QuYXNzaWduKHtjbWQ6IHR5cGV9LCBleHRyYSk7XG4gICAgICBsZXQgY21kSnNvbiA9IGAke0pTT04uc3RyaW5naWZ5KGNtZCl9IFxcbmA7XG4gICAgICBsb2cuZGVidWcoYFNlbmRpbmcgY29tbWFuZCB0byBhbmRyb2lkOiAke18udHJ1bmNhdGUoY21kSnNvbiwge2xlbmd0aDogMTAwMH0pLnRyaW0oKX1gKTtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50LndyaXRlKGNtZEpzb24pO1xuICAgICAgdGhpcy5zb2NrZXRDbGllbnQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICAgIGxldCBzdHJlYW1EYXRhID0gJyc7XG4gICAgICBsZXQgc2VuZENvbW1hbmRUaW1lb3V0SGFuZGxlciA9IG51bGw7XG4gICAgICB0aGlzLnNvY2tldENsaWVudC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgIGlmIChzZW5kQ29tbWFuZFRpbWVvdXRIYW5kbGVyKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5kZWJ1ZygnUmVjZWl2ZWQgY29tbWFuZCByZXN1bHQgZnJvbSBib290c3RyYXAnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBzdHJlYW1EYXRhID0gSlNPTi5wYXJzZShzdHJlYW1EYXRhICsgZGF0YSk7XG4gICAgICAgICAgLy8gd2Ugc3VjY2Vzc2Z1bGx5IHBhcnNlZCBKU09OIHNvIHdlJ3ZlIGdvdCBhbGwgdGhlIGRhdGEsXG4gICAgICAgICAgLy8gcmVtb3ZlIHRoZSBzb2NrZXQgbGlzdGVuZXIgYW5kIGV2YWx1YXRlXG4gICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQucmVtb3ZlQWxsTGlzdGVuZXJzKCdkYXRhJyk7XG4gICAgICAgICAgaWYgKHN0cmVhbURhdGEuc3RhdHVzID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShzdHJlYW1EYXRhLnZhbHVlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVqZWN0KGVycm9yRnJvbUNvZGUoc3RyZWFtRGF0YS5zdGF0dXMsIHN0cmVhbURhdGEudmFsdWUpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgaWYgKCFfLmlzU3RyaW5nKHN0cmVhbURhdGEpKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoJ0dvdCBhbiB1bmV4cGVjdGVkIGVycm9yIGluc2lkZSBzb2NrZXQgbGlzdGVuZXInKTtcbiAgICAgICAgICAgIGxvZy5lcnJvcihlcnIuc3RhY2spO1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvckZyb21Db2RlKDEzLCBlcnIubWVzc2FnZSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2cuZGVidWcoYFN0cmVhbSBzdGlsbCBub3QgY29tcGxldGUsIHdhaXRpbmcgdXAgdG8gJHtTRU5EX0NPTU1BTkRfVElNRU9VVH1tcyBmb3IgdGhlIGRhdGEgdG8gYXJyaXZlYCk7XG4gICAgICAgICAgc3RyZWFtRGF0YSArPSBkYXRhO1xuICAgICAgICAgIHNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVyck1zZyA9IGBTZXJ2ZXIgc29ja2V0IHN0b3BwZWQgcmVzcG9uZGluZy4gVGhlIHJlY2VudCByZXNwb25zZSB3YXMgJyR7c3RyZWFtRGF0YX0nYDtcbiAgICAgICAgICAgIGxvZy5lcnJvcihlcnJNc2cpO1xuICAgICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQucmVtb3ZlQWxsTGlzdGVuZXJzKCdkYXRhJyk7XG4gICAgICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZSgxMywgZXJyTXNnKSk7XG4gICAgICAgICAgfSwgU0VORF9DT01NQU5EX1RJTUVPVVQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRBY3Rpb24gKGFjdGlvbiwgcGFyYW1zID0ge30pIHtcbiAgICBsZXQgZXh0cmEgPSB7YWN0aW9uLCBwYXJhbXN9O1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuQUNUSU9OLCBleHRyYSk7XG4gIH1cblxuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgaWYgKCF0aGlzLnVpQXV0b21hdG9yKSB7XG4gICAgICBsb2cud2FybignQ2Fubm90IHNodXQgZG93biBBbmRyb2lkIGJvb3RzdHJhcDsgaXQgaGFzIGFscmVhZHkgc2h1dCBkb3duJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGxpc3RuZXJzIHNvIHdlIGRvbid0IHRyaWdnZXIgdW5leHBlY3RlZCBzaHV0ZG93blxuICAgIHRoaXMudWlBdXRvbWF0b3IucmVtb3ZlQWxsTGlzdGVuZXJzKFVpQXV0b21hdG9yLkVWRU5UX0NIQU5HRUQpO1xuICAgIGlmICh0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgYXdhaXQgdGhpcy5zZW5kQ29tbWFuZChDT01NQU5EX1RZUEVTLlNIVVRET1dOKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy51aUF1dG9tYXRvci5zaHV0ZG93bigpO1xuICAgIHRoaXMudWlBdXRvbWF0b3IgPSBudWxsO1xuICB9XG5cbiAgLy8gdGhpcyBoZWxwZXIgZnVuY3Rpb24gbWFrZXMgdW5pdCB0ZXN0aW5nIGVhc2llci5cbiAgYXN5bmMgaW5pdCAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIHRoaXMudWlBdXRvbWF0b3IgPSBuZXcgVWlBdXRvbWF0b3IodGhpcy5hZGIpO1xuXG4gICAgLy8gSGFuZGxlIHVuZXhwZWN0ZWQgVWlBdXRvbWF0b3Igc2h1dGRvd25cbiAgICB0aGlzLnVpQXV0b21hdG9yLm9uKFVpQXV0b21hdG9yLkVWRU5UX0NIQU5HRUQsIChtc2cpID0+IHtcbiAgICAgIGlmIChtc2cuc3RhdGUgPT09IFVpQXV0b21hdG9yLlNUQVRFX1NUT1BQRUQpIHtcbiAgICAgICAgdGhpcy51aUF1dG9tYXRvciA9IG51bGw7XG4gICAgICAgIHRoaXMub25VbmV4cGVjdGVkU2h1dGRvd24uY2FuY2VsKG5ldyBFcnJvcignVWlBVXRvbWF0b3Igc2h1dCBkb3duIHVuZXhwZWN0ZWRseScpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNldCBpZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gKGlnbm9yZSkge1xuICAgIGxvZy5kZWJ1ZyhgJHtpZ25vcmUgPyAnSWdub3JpbmcnIDogJ1dhdGNoaW5nIGZvcid9IGJvb3RzdHJhcCBkaXNjb25uZWN0YCk7XG4gICAgdGhpcy5faWdub3JlVW5leHBlY3RlZFNodXRkb3duID0gaWdub3JlO1xuICB9XG5cbiAgZ2V0IGlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93bjtcbiAgfVxufVxuXG5leHBvcnQgeyBBbmRyb2lkQm9vdHN0cmFwLCBDT01NQU5EX1RZUEVTIH07XG5leHBvcnQgZGVmYXVsdCBBbmRyb2lkQm9vdHN0cmFwO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBR0EsTUFBTUEsR0FBRyxHQUFHQyxlQUFNLENBQUNDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQztBQUNoRCxNQUFNQyxhQUFhLEdBQUc7RUFDcEJDLE1BQU0sRUFBRSxRQUFRO0VBQ2hCQyxRQUFRLEVBQUU7QUFDWixDQUFD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