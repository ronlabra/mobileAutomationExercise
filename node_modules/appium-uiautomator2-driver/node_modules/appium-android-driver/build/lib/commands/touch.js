"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = exports.commands = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _androidHelpers = _interopRequireDefault(require("../android-helpers"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _driver = require("appium/driver");
var _asyncbox = require("asyncbox");
var _support = require("appium/support");
let commands = {},
  helpers = {},
  extensions = {};
exports.helpers = helpers;
exports.commands = commands;
function getCoordDefault(val) {
  return _support.util.hasValue(val) ? val : 0.5;
}
function getSwipeTouchDuration(waitGesture) {
  let duration = 0.8;
  if (typeof waitGesture.options.ms !== 'undefined' && waitGesture.options.ms) {
    duration = waitGesture.options.ms / 1000;
    if (duration === 0) {
      duration = 0.1;
    }
  }
  return duration;
}
commands.doTouchAction = async function doTouchAction(action, opts = {}) {
  const {
    element,
    x,
    y,
    count,
    ms,
    duration
  } = opts;
  switch (action) {
    case 'tap':
      return await this.tap(null, x, y, count);
    case 'press':
      return await this.touchDown(null, x, y);
    case 'release':
      return await this.touchUp(element, x, y);
    case 'moveTo':
      return await this.touchMove(null, x, y);
    case 'wait':
      return await _bluebird.default.delay(ms);
    case 'longPress':
      return await this.touchLongClick(null, x, y, duration || 1000);
    case 'cancel':
      this.log.warn('Cancel action currently has no effect');
      break;
    default:
      this.log.errorAndThrow(`unknown action ${action}`);
  }
};

helpers.doTouchDrag = async function doTouchDrag(gestures) {
  let longPress = gestures[0];
  let moveTo = gestures[1];
  let startX = longPress.options.x || 0,
    startY = longPress.options.y || 0,
    endX = moveTo.options.x || 0,
    endY = moveTo.options.y || 0;
  if (longPress.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(longPress.options.element);
    startX += x || 0;
    startY += y || 0;
  }
  if (moveTo.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(moveTo.options.element);
    endX += x || 0;
    endY += y || 0;
  }
  let apiLevel = await this.adb.getApiLevel();
  let duration = apiLevel >= 5 ? 2 : 1;
  if (longPress.options && longPress.options.duration) {
    duration = Math.max(longPress.options.duration / 1000, duration);
  }

  return await this.drag(startX, startY, endX, endY, duration, 1, longPress.options.element, moveTo.options.element);
};

helpers.fixRelease = async function fixRelease(gestures) {
  let release = _lodash.default.last(gestures);
  release.options = release.options || {};
  if (release.options.element || release.options.x && release.options.y) {
    return;
  }
  gestures = _lodash.default.clone(gestures);
  let ref = null;
  for (let gesture of gestures.reverse()) {
    let opts = gesture.options;
    if (opts.element || opts.x && opts.y) {
      ref = gesture;
      break;
    }
  }
  if (ref) {
    let opts = ref.options;
    if (opts.element) {
      let loc = await this.getLocationInView(opts.element);
      if (opts.x && opts.y) {
        release.options = {
          x: loc.x + opts.x,
          y: loc.y + opts.y
        };
      } else {
        let size = await this.getSize(opts.element);
        release.options = {
          x: loc.x + size.width / 2,
          y: loc.y + size.height / 2
        };
      }
    } else {
      release.options = _lodash.default.pick(opts, 'x', 'y');
    }
  }
  return release;
};

helpers.performGesture = async function performGesture(gesture) {
  try {
    return await this.doTouchAction(gesture.action, gesture.options || {});
  } catch (e) {
    if ((0, _driver.isErrorType)(e, _driver.errors.NoSuchElementError) && gesture.action === 'release' && gesture.options.element) {
      delete gesture.options.element;
      this.log.debug(`retrying release without element opts: ${gesture.options}.`);
      return await this.doTouchAction(gesture.action, gesture.options || {});
    }
    throw e;
  }
};
commands.getSwipeOptions = async function getSwipeOptions(gestures, touchCount = 1) {
  let startX = getCoordDefault(gestures[0].options.x),
    startY = getCoordDefault(gestures[0].options.y),
    endX = getCoordDefault(gestures[2].options.x),
    endY = getCoordDefault(gestures[2].options.y),
    duration = getSwipeTouchDuration(gestures[1]),
    element = gestures[0].options.element,
    destElement = gestures[2].options.element || gestures[0].options.element;

  if (_support.util.hasValue(destElement)) {
    let locResult = await this.getLocationInView(destElement);
    let sizeResult = await this.getSize(destElement);
    let offsetX = Math.abs(endX) < 1 && Math.abs(endX) > 0 ? sizeResult.width * endX : endX;
    let offsetY = Math.abs(endY) < 1 && Math.abs(endY) > 0 ? sizeResult.height * endY : endY;
    endX = locResult.x + offsetX;
    endY = locResult.y + offsetY;
    if (_support.util.hasValue(element)) {
      let firstElLocation = await this.getLocationInView(element);
      endX -= firstElLocation.x;
      endY -= firstElLocation.y;
    }
  }
  return {
    startX,
    startY,
    endX,
    endY,
    duration,
    touchCount,
    element
  };
};
commands.performTouch = async function performTouch(gestures) {
  if (gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release') {
    let swipeOpts = await this.getSwipeOptions(gestures);
    return await this.swipe(swipeOpts.startX, swipeOpts.startY, swipeOpts.endX, swipeOpts.endY, swipeOpts.duration, swipeOpts.touchCount, swipeOpts.element);
  }
  let actions = _lodash.default.map(gestures, 'action');
  if (actions[0] === 'longPress' && actions[1] === 'moveTo' && actions[2] === 'release') {
    return await this.doTouchDrag(gestures);
  } else {
    if (actions.length === 2) {
      if (_lodash.default.head(actions) === 'press' && _lodash.default.last(actions) === 'release') {
        actions[0] = 'tap';
        gestures[0].action = 'tap';
      }

      if ((_lodash.default.head(actions) === 'tap' || _lodash.default.head(actions) === 'longPress') && _lodash.default.last(actions) === 'release') {
        gestures.pop();
        actions.pop();
      }
    } else {
      if (actions[0] === 'longPress') {
        actions = ['press', 'wait', ...actions.slice(1)];
        let press = gestures.shift();
        press.action = 'press';
        let wait = {
          action: 'wait',
          options: {
            ms: press.options.duration || 1000
          }
        };
        delete press.options.duration;
        gestures = [press, wait, ...gestures];
      }
    }
    let fixedGestures = await this.parseTouch(gestures, false);
    if (actions[actions.length - 1] === 'release') {
      actions[actions.length - 1] = await this.fixRelease(gestures);
    }
    for (let g of fixedGestures) {
      await this.performGesture(g);
    }
  }
};
helpers.parseTouch = async function parseTouch(gestures, multi) {
  if (multi && _lodash.default.last(gestures).action === 'release') {
    gestures.pop();
  }
  let touchStateObjects = await (0, _asyncbox.asyncmap)(gestures, async gesture => {
    let options = gesture.options || {};
    if (_lodash.default.includes(['press', 'moveTo', 'tap', 'longPress'], gesture.action)) {
      options.offset = false;
      let elementId = gesture.options.element;
      if (elementId) {
        let pos = await this.getLocationInView(elementId);
        if (gesture.options.x || gesture.options.y) {
          options.x = pos.x + (gesture.options.x || 0);
          options.y = pos.y + (gesture.options.y || 0);
        } else {
          const {
            width,
            height
          } = await this.getSize(elementId);
          options.x = pos.x + width / 2;
          options.y = pos.y + height / 2;
        }
        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      } else {
        options.x = gesture.options.x || 0;
        options.y = gesture.options.y || 0;
        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      }
    } else {
      let offset = 0.005;
      if (gesture.action === 'wait') {
        options = gesture.options;
        offset = parseInt(gesture.options.ms, 10) / 1000;
      }
      let touchStateObject = {
        action: gesture.action,
        options,
        timeOffset: offset
      };
      return touchStateObject;
    }
  }, false);
  let prevPos = null,
    time = 0;
  for (let state of touchStateObjects) {
    if (_lodash.default.isUndefined(state.options.x) && _lodash.default.isUndefined(state.options.y) && prevPos !== null) {
      state.options.x = prevPos.x;
      state.options.y = prevPos.y;
    }
    if (state.options.offset && prevPos) {
      state.options.x += prevPos.x;
      state.options.y += prevPos.y;
    }
    delete state.options.offset;
    if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
      prevPos = state.options;
    }
    if (multi) {
      let timeOffset = state.timeOffset;
      time += timeOffset;
      state.time = _androidHelpers.default.truncateDecimals(time, 3);

      if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
        state.touch = {
          x: state.options.x,
          y: state.options.y
        };
      }
      delete state.options;
    }
    delete state.timeOffset;
  }
  return touchStateObjects;
};
commands.performMultiAction = async function performMultiAction(actions, elementId) {
  if (actions.length === 1) {
    throw new Error('Multi Pointer Gestures need at least two actions. ' + 'Use Touch Actions for a single action.');
  }
  const states = await (0, _asyncbox.asyncmap)(actions, async action => await this.parseTouch(action, true), false);
  return await this.doPerformMultiAction(elementId, states);
};

commands.doPerformMultiAction = async function doPerformMultiAction(elementId, states) {
  let opts;
  if (elementId) {
    opts = {
      elementId,
      actions: states
    };
    return await this.bootstrap.sendAction('element:performMultiPointerGesture', opts);
  } else {
    opts = {
      actions: states
    };
    return await this.bootstrap.sendAction('performMultiPointerGesture', opts);
  }
};
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZ2V0Q29vcmREZWZhdWx0IiwidmFsIiwidXRpbCIsImhhc1ZhbHVlIiwiZ2V0U3dpcGVUb3VjaER1cmF0aW9uIiwid2FpdEdlc3R1cmUiLCJkdXJhdGlvbiIsIm9wdGlvbnMiLCJtcyIsImRvVG91Y2hBY3Rpb24iLCJhY3Rpb24iLCJvcHRzIiwiZWxlbWVudCIsIngiLCJ5IiwiY291bnQiLCJ0YXAiLCJ0b3VjaERvd24iLCJ0b3VjaFVwIiwidG91Y2hNb3ZlIiwiQiIsImRlbGF5IiwidG91Y2hMb25nQ2xpY2siLCJsb2ciLCJ3YXJuIiwiZXJyb3JBbmRUaHJvdyIsImRvVG91Y2hEcmFnIiwiZ2VzdHVyZXMiLCJsb25nUHJlc3MiLCJtb3ZlVG8iLCJzdGFydFgiLCJzdGFydFkiLCJlbmRYIiwiZW5kWSIsImdldExvY2F0aW9uSW5WaWV3IiwiYXBpTGV2ZWwiLCJhZGIiLCJnZXRBcGlMZXZlbCIsIk1hdGgiLCJtYXgiLCJkcmFnIiwiZml4UmVsZWFzZSIsInJlbGVhc2UiLCJfIiwibGFzdCIsImNsb25lIiwicmVmIiwiZ2VzdHVyZSIsInJldmVyc2UiLCJsb2MiLCJzaXplIiwiZ2V0U2l6ZSIsIndpZHRoIiwiaGVpZ2h0IiwicGljayIsInBlcmZvcm1HZXN0dXJlIiwiZSIsImlzRXJyb3JUeXBlIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiZGVidWciLCJnZXRTd2lwZU9wdGlvbnMiLCJ0b3VjaENvdW50IiwiZGVzdEVsZW1lbnQiLCJsb2NSZXN1bHQiLCJzaXplUmVzdWx0Iiwib2Zmc2V0WCIsImFicyIsIm9mZnNldFkiLCJmaXJzdEVsTG9jYXRpb24iLCJwZXJmb3JtVG91Y2giLCJsZW5ndGgiLCJzd2lwZU9wdHMiLCJzd2lwZSIsImFjdGlvbnMiLCJtYXAiLCJoZWFkIiwicG9wIiwic2xpY2UiLCJwcmVzcyIsInNoaWZ0Iiwid2FpdCIsImZpeGVkR2VzdHVyZXMiLCJwYXJzZVRvdWNoIiwiZyIsIm11bHRpIiwidG91Y2hTdGF0ZU9iamVjdHMiLCJhc3luY21hcCIsImluY2x1ZGVzIiwib2Zmc2V0IiwiZWxlbWVudElkIiwicG9zIiwidG91Y2hTdGF0ZU9iamVjdCIsInRpbWVPZmZzZXQiLCJwYXJzZUludCIsInByZXZQb3MiLCJ0aW1lIiwic3RhdGUiLCJpc1VuZGVmaW5lZCIsImFuZHJvaWRIZWxwZXJzIiwidHJ1bmNhdGVEZWNpbWFscyIsInRvdWNoIiwicGVyZm9ybU11bHRpQWN0aW9uIiwiRXJyb3IiLCJzdGF0ZXMiLCJkb1BlcmZvcm1NdWx0aUFjdGlvbiIsImJvb3RzdHJhcCIsInNlbmRBY3Rpb24iLCJPYmplY3QiLCJhc3NpZ24iXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvY29tbWFuZHMvdG91Y2guanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhbmRyb2lkSGVscGVycyBmcm9tICcuLi9hbmRyb2lkLWhlbHBlcnMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSB9IGZyb20gJ2FwcGl1bS9kcml2ZXInO1xuaW1wb3J0IHsgYXN5bmNtYXAgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmZ1bmN0aW9uIGdldENvb3JkRGVmYXVsdCAodmFsKSB7XG4gIC8vIGdvaW5nIHRoZSBsb25nIHdheSBhbmQgY2hlY2tpbmcgZm9yIHVuZGVmaW5lZCBhbmQgbnVsbCBzaW5jZVxuICAvLyB3ZSBjYW4ndCBiZSBhc3N1cmVkIGBlbElkYCBpcyBhIHN0cmluZyBhbmQgbm90IGFuIGludC4gU2FtZVxuICAvLyB0aGluZyB3aXRoIGRlc3RFbGVtZW50IGJlbG93LlxuICByZXR1cm4gdXRpbC5oYXNWYWx1ZSh2YWwpID8gdmFsIDogMC41O1xufVxuXG5mdW5jdGlvbiBnZXRTd2lwZVRvdWNoRHVyYXRpb24gKHdhaXRHZXN0dXJlKSB7XG4gIC8vIHRoZSB0b3VjaCBhY3Rpb24gYXBpIHVzZXMgbXMsIHdlIHdhbnQgc2Vjb25kc1xuICAvLyAwLjggaXMgdGhlIGRlZmF1bHQgdGltZSBmb3IgdGhlIG9wZXJhdGlvblxuICBsZXQgZHVyYXRpb24gPSAwLjg7XG4gIGlmICh0eXBlb2Ygd2FpdEdlc3R1cmUub3B0aW9ucy5tcyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2FpdEdlc3R1cmUub3B0aW9ucy5tcykge1xuICAgIGR1cmF0aW9uID0gd2FpdEdlc3R1cmUub3B0aW9ucy5tcyAvIDEwMDA7XG4gICAgaWYgKGR1cmF0aW9uID09PSAwKSB7XG4gICAgICAvLyBzZXQgdG8gYSB2ZXJ5IGxvdyBudW1iZXIsIHNpbmNlIHRoZXkgd2FudGVkIGl0IGZhc3RcbiAgICAgIC8vIGJ1dCBiZWxvdyAwLjEgYmVjb21lcyAwIHN0ZXBzLCB3aGljaCBjYXVzZXMgZXJyb3JzXG4gICAgICBkdXJhdGlvbiA9IDAuMTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGR1cmF0aW9uO1xufVxuXG5jb21tYW5kcy5kb1RvdWNoQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gZG9Ub3VjaEFjdGlvbiAoYWN0aW9uLCBvcHRzID0ge30pIHtcbiAgY29uc3QgeyBlbGVtZW50LCB4LCB5LCBjb3VudCwgbXMsIGR1cmF0aW9uIH0gPSBvcHRzO1xuICAvLyBwYXJzZVRvdWNoIHByZWNhbGN1bGF0ZXMgYWJzb2x1dGUgZWxlbWVudCBwb3NpdGlvbnNcbiAgLy8gc28gdGhlcmUgaXMgbm8gbmVlZCB0byBwYXNzIGBlbGVtZW50YCB0byB0aGUgYWZmZWN0ZWQgZ2VzdHVyZXNcbiAgc3dpdGNoIChhY3Rpb24pIHtcbiAgICBjYXNlICd0YXAnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFwKG51bGwsIHgsIHksIGNvdW50KTtcbiAgICBjYXNlICdwcmVzcyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaERvd24obnVsbCwgeCwgeSk7XG4gICAgY2FzZSAncmVsZWFzZSc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaFVwKGVsZW1lbnQsIHgsIHkpO1xuICAgIGNhc2UgJ21vdmVUbyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaE1vdmUobnVsbCwgeCwgeSk7XG4gICAgY2FzZSAnd2FpdCc6XG4gICAgICByZXR1cm4gYXdhaXQgQi5kZWxheShtcyk7XG4gICAgY2FzZSAnbG9uZ1ByZXNzJzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRvdWNoTG9uZ0NsaWNrKG51bGwsIHgsIHksIGR1cmF0aW9uIHx8IDEwMDApO1xuICAgIGNhc2UgJ2NhbmNlbCc6XG4gICAgICAvLyBUT0RPOiBjbGFyaWZ5IGJlaGF2aW9yIG9mICdjYW5jZWwnIGFjdGlvbiBhbmQgZml4IHRoaXNcbiAgICAgIHRoaXMubG9nLndhcm4oJ0NhbmNlbCBhY3Rpb24gY3VycmVudGx5IGhhcyBubyBlZmZlY3QnKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KGB1bmtub3duIGFjdGlvbiAke2FjdGlvbn1gKTtcbiAgfVxufTtcblxuLy8gZHJhZyBpcyAqbm90KiBwcmVzcy1tb3ZlLXJlbGVhc2UsIHNvIHdlIG5lZWQgdG8gdHJhbnNsYXRlXG4vLyBkcmFnIHdvcmtzIGZpbmUgZm9yIHNjcm9sbCwgYXMgd2VsbFxuaGVscGVycy5kb1RvdWNoRHJhZyA9IGFzeW5jIGZ1bmN0aW9uIGRvVG91Y2hEcmFnIChnZXN0dXJlcykge1xuICBsZXQgbG9uZ1ByZXNzID0gZ2VzdHVyZXNbMF07XG4gIGxldCBtb3ZlVG8gPSBnZXN0dXJlc1sxXTtcbiAgbGV0IHN0YXJ0WCA9IGxvbmdQcmVzcy5vcHRpb25zLnggfHwgMCxcbiAgICAgIHN0YXJ0WSA9IGxvbmdQcmVzcy5vcHRpb25zLnkgfHwgMCxcbiAgICAgIGVuZFggPSBtb3ZlVG8ub3B0aW9ucy54IHx8IDAsXG4gICAgICBlbmRZID0gbW92ZVRvLm9wdGlvbnMueSB8fCAwO1xuICBpZiAobG9uZ1ByZXNzLm9wdGlvbnMuZWxlbWVudCkge1xuICAgIGxldCB7eCwgeX0gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGxvbmdQcmVzcy5vcHRpb25zLmVsZW1lbnQpO1xuICAgIHN0YXJ0WCArPSB4IHx8IDA7XG4gICAgc3RhcnRZICs9IHkgfHwgMDtcbiAgfVxuICBpZiAobW92ZVRvLm9wdGlvbnMuZWxlbWVudCkge1xuICAgIGxldCB7eCwgeX0gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KG1vdmVUby5vcHRpb25zLmVsZW1lbnQpO1xuICAgIGVuZFggKz0geCB8fCAwO1xuICAgIGVuZFkgKz0geSB8fCAwO1xuICB9XG5cbiAgbGV0IGFwaUxldmVsID0gYXdhaXQgdGhpcy5hZGIuZ2V0QXBpTGV2ZWwoKTtcbiAgLy8gbG9sbGlwb3AgdGFrZXMgYSBsaXR0bGUgbG9uZ2VyIHRvIGdldCB0aGluZ3Mgcm9sbGluZ1xuICBsZXQgZHVyYXRpb24gPSBhcGlMZXZlbCA+PSA1ID8gMiA6IDE7XG4gIC8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBsb25nIHByZXNzIGhhcyBhIGR1cmF0aW9uLCB3ZSB1c2UgaXQuXG4gIGlmIChsb25nUHJlc3Mub3B0aW9ucyAmJiBsb25nUHJlc3Mub3B0aW9ucy5kdXJhdGlvbikge1xuICAgIGR1cmF0aW9uID0gTWF0aC5tYXgobG9uZ1ByZXNzLm9wdGlvbnMuZHVyYXRpb24gLyAxMDAwLCBkdXJhdGlvbik7XG4gIH1cblxuICAvLyBgZHJhZ2Agd2lsbCB0YWtlIGNhcmUgb2Ygd2hldGhlciB0aGVyZSBpcyBhbiBlbGVtZW50IG9yIG5vdCBhdCB0aGF0IGxldmVsXG4gIHJldHVybiBhd2FpdCB0aGlzLmRyYWcoc3RhcnRYLCBzdGFydFksIGVuZFgsIGVuZFksIGR1cmF0aW9uLCAxLCBsb25nUHJlc3Mub3B0aW9ucy5lbGVtZW50LCBtb3ZlVG8ub3B0aW9ucy5lbGVtZW50KTtcbn07XG5cbi8vIFJlbGVhc2UgZ2VzdHVyZSBuZWVkcyBlbGVtZW50IG9yIGNvLW9yZGluYXRlcyB0byByZWxlYXNlIGl0IGZyb20gdGhhdCBwb3NpdGlvblxuLy8gb3IgZWxzZSByZWxlYXNlIGdlc3R1cmUgaXMgcGVyZm9ybWVkIGZyb20gY2VudGVyIG9mIHRoZSBzY3JlZW4sIHNvIHRvIGZpeCBpdFxuLy8gVGhpcyBtZXRob2Qgc2V0cyBjby1vcmRpbmF0ZXMvZWxlbWVudCB0byByZWxlYXNlIGdlc3R1cmUgaWYgaXQgaGFzIG5vIG9wdGlvbnMgc2V0IGFscmVhZHkuXG5oZWxwZXJzLmZpeFJlbGVhc2UgPSBhc3luYyBmdW5jdGlvbiBmaXhSZWxlYXNlIChnZXN0dXJlcykge1xuICBsZXQgcmVsZWFzZSA9IF8ubGFzdChnZXN0dXJlcyk7XG4gIC8vIHNvbWV0aW1lcyB0aGVyZSBhcmUgbm8gb3B0aW9uc1xuICByZWxlYXNlLm9wdGlvbnMgPSByZWxlYXNlLm9wdGlvbnMgfHwge307XG4gIC8vIG5vdGhpbmcgdG8gZG8gaWYgcmVsZWFzZSBvcHRpb25zIGFyZSBhbHJlYWR5IHNldFxuICBpZiAocmVsZWFzZS5vcHRpb25zLmVsZW1lbnQgfHwgKHJlbGVhc2Uub3B0aW9ucy54ICYmIHJlbGVhc2Uub3B0aW9ucy55KSkge1xuICAgIHJldHVybjtcbiAgfVxuICAvLyB3aXRob3V0IGNvb3JkaW5hdGVzLCBgcmVsZWFzZWAgdXNlcyB0aGUgY2VudGVyIG9mIHRoZSBzY3JlZW4sIHdoaWNoLFxuICAvLyBnZW5lcmFsbHkgc3BlYWtpbmcsIGlzIG5vdCB3aGF0IHdlIHdhbnRcbiAgLy8gdGhlcmVmb3JlOiBsb29wIGJhY2t3YXJkcyBhbmQgdXNlIHRoZSBsYXN0IGNvbW1hbmQgd2l0aCBhbiBlbGVtZW50IGFuZC9vclxuICAvLyBvZmZzZXQgY29vcmRpbmF0ZXNcbiAgZ2VzdHVyZXMgPSBfLmNsb25lKGdlc3R1cmVzKTtcbiAgbGV0IHJlZiA9IG51bGw7XG4gIGZvciAobGV0IGdlc3R1cmUgb2YgZ2VzdHVyZXMucmV2ZXJzZSgpKSB7XG4gICAgbGV0IG9wdHMgPSBnZXN0dXJlLm9wdGlvbnM7XG4gICAgaWYgKG9wdHMuZWxlbWVudCB8fCAob3B0cy54ICYmIG9wdHMueSkpIHtcbiAgICAgIHJlZiA9IGdlc3R1cmU7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgaWYgKHJlZikge1xuICAgIGxldCBvcHRzID0gcmVmLm9wdGlvbnM7XG4gICAgaWYgKG9wdHMuZWxlbWVudCkge1xuICAgICAgbGV0IGxvYyA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcob3B0cy5lbGVtZW50KTtcbiAgICAgIGlmIChvcHRzLnggJiYgb3B0cy55KSB7XG4gICAgICAgIC8vIHRoaXMgaXMgYW4gb2Zmc2V0IGZyb20gdGhlIGVsZW1lbnRcbiAgICAgICAgcmVsZWFzZS5vcHRpb25zID0ge1xuICAgICAgICAgIHg6IGxvYy54ICsgb3B0cy54LFxuICAgICAgICAgIHk6IGxvYy55ICsgb3B0cy55XG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0aGlzIGlzIHRoZSBjZW50ZXIgb2YgdGhlIGVsZW1lbnRcbiAgICAgICAgbGV0IHNpemUgPSBhd2FpdCB0aGlzLmdldFNpemUob3B0cy5lbGVtZW50KTtcbiAgICAgICAgcmVsZWFzZS5vcHRpb25zID0ge1xuICAgICAgICAgIHg6IGxvYy54ICsgc2l6ZS53aWR0aCAvIDIsXG4gICAgICAgICAgeTogbG9jLnkgKyBzaXplLmhlaWdodCAvIDJcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVsZWFzZS5vcHRpb25zID0gXy5waWNrKG9wdHMsICd4JywgJ3knKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlbGVhc2U7XG59O1xuXG4vLyBQZXJmb3JtIG9uZSBnZXN0dXJlXG5oZWxwZXJzLnBlcmZvcm1HZXN0dXJlID0gYXN5bmMgZnVuY3Rpb24gcGVyZm9ybUdlc3R1cmUgKGdlc3R1cmUpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kb1RvdWNoQWN0aW9uKGdlc3R1cmUuYWN0aW9uLCBnZXN0dXJlLm9wdGlvbnMgfHwge30pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gc29tZXRpbWUgdGhlIGVsZW1lbnQgaXMgbm90IGF2YWlsYWJsZSB3aGVuIHJlbGVhc2luZywgcmV0cnkgd2l0aG91dCBpdFxuICAgIGlmIChpc0Vycm9yVHlwZShlLCBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKSAmJiBnZXN0dXJlLmFjdGlvbiA9PT0gJ3JlbGVhc2UnICYmXG4gICAgICAgIGdlc3R1cmUub3B0aW9ucy5lbGVtZW50KSB7XG4gICAgICBkZWxldGUgZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgcmV0cnlpbmcgcmVsZWFzZSB3aXRob3V0IGVsZW1lbnQgb3B0czogJHtnZXN0dXJlLm9wdGlvbnN9LmApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZG9Ub3VjaEFjdGlvbihnZXN0dXJlLmFjdGlvbiwgZ2VzdHVyZS5vcHRpb25zIHx8IHt9KTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0U3dpcGVPcHRpb25zID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3dpcGVPcHRpb25zIChnZXN0dXJlcywgdG91Y2hDb3VudCA9IDEpIHtcbiAgbGV0IHN0YXJ0WCA9IGdldENvb3JkRGVmYXVsdChnZXN0dXJlc1swXS5vcHRpb25zLngpLFxuICAgICAgc3RhcnRZID0gZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzBdLm9wdGlvbnMueSksXG4gICAgICBlbmRYID0gZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzJdLm9wdGlvbnMueCksXG4gICAgICBlbmRZID0gZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzJdLm9wdGlvbnMueSksXG4gICAgICBkdXJhdGlvbiA9IGdldFN3aXBlVG91Y2hEdXJhdGlvbihnZXN0dXJlc1sxXSksXG4gICAgICBlbGVtZW50ID0gZ2VzdHVyZXNbMF0ub3B0aW9ucy5lbGVtZW50LFxuICAgICAgZGVzdEVsZW1lbnQgPSBnZXN0dXJlc1syXS5vcHRpb25zLmVsZW1lbnQgfHwgZ2VzdHVyZXNbMF0ub3B0aW9ucy5lbGVtZW50O1xuXG4gIC8vIHRoZXJlJ3Mgbm8gZGVzdGluYXRpb24gZWxlbWVudCBoYW5kbGluZyBpbiBib290c3RyYXAgYW5kIHNpbmNlIGl0IGFwcGxpZXMgdG8gYWxsIHBsYXRmb3Jtcywgd2UgaGFuZGxlIGl0IGhlcmVcbiAgaWYgKHV0aWwuaGFzVmFsdWUoZGVzdEVsZW1lbnQpKSB7XG4gICAgbGV0IGxvY1Jlc3VsdCA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZGVzdEVsZW1lbnQpO1xuICAgIGxldCBzaXplUmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRTaXplKGRlc3RFbGVtZW50KTtcbiAgICBsZXQgb2Zmc2V0WCA9IChNYXRoLmFicyhlbmRYKSA8IDEgJiYgTWF0aC5hYnMoZW5kWCkgPiAwKSA/IHNpemVSZXN1bHQud2lkdGggKiBlbmRYIDogZW5kWDtcbiAgICBsZXQgb2Zmc2V0WSA9IChNYXRoLmFicyhlbmRZKSA8IDEgJiYgTWF0aC5hYnMoZW5kWSkgPiAwKSA/IHNpemVSZXN1bHQuaGVpZ2h0ICogZW5kWSA6IGVuZFk7XG4gICAgZW5kWCA9IGxvY1Jlc3VsdC54ICsgb2Zmc2V0WDtcbiAgICBlbmRZID0gbG9jUmVzdWx0LnkgKyBvZmZzZXRZO1xuICAgIC8vIGlmIHRoZSB0YXJnZXQgZWxlbWVudCB3YXMgcHJvdmlkZWQsIHRoZSBjb29yZGluYXRlcyBmb3IgdGhlIGRlc3RpbmF0aW9uIG5lZWQgdG8gYmUgcmVsYXRpdmUgdG8gaXQuXG4gICAgaWYgKHV0aWwuaGFzVmFsdWUoZWxlbWVudCkpIHtcbiAgICAgIGxldCBmaXJzdEVsTG9jYXRpb24gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGVsZW1lbnQpO1xuICAgICAgZW5kWCAtPSBmaXJzdEVsTG9jYXRpb24ueDtcbiAgICAgIGVuZFkgLT0gZmlyc3RFbExvY2F0aW9uLnk7XG4gICAgfVxuICB9XG4gIC8vIGNsaWVudHMgYXJlIHJlc3BvbnNpYmxlIHRvIHVzZSB0aGVzZSBvcHRpb25zIGNvcnJlY3RseVxuICByZXR1cm4ge3N0YXJ0WCwgc3RhcnRZLCBlbmRYLCBlbmRZLCBkdXJhdGlvbiwgdG91Y2hDb3VudCwgZWxlbWVudH07XG59O1xuXG5jb21tYW5kcy5wZXJmb3JtVG91Y2ggPSBhc3luYyBmdW5jdGlvbiBwZXJmb3JtVG91Y2ggKGdlc3R1cmVzKSB7XG4gIC8vIHByZXNzLXdhaXQtbW92ZVRvLXJlbGVhc2UgaXMgYHN3aXBlYCwgc28gdXNlIG5hdGl2ZSBtZXRob2RcbiAgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gNCAmJlxuICAgICAgZ2VzdHVyZXNbMF0uYWN0aW9uID09PSAncHJlc3MnICYmXG4gICAgICBnZXN0dXJlc1sxXS5hY3Rpb24gPT09ICd3YWl0JyAmJlxuICAgICAgZ2VzdHVyZXNbMl0uYWN0aW9uID09PSAnbW92ZVRvJyAmJlxuICAgICAgZ2VzdHVyZXNbM10uYWN0aW9uID09PSAncmVsZWFzZScpIHtcblxuICAgIGxldCBzd2lwZU9wdHMgPSBhd2FpdCB0aGlzLmdldFN3aXBlT3B0aW9ucyhnZXN0dXJlcyk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc3dpcGUoc3dpcGVPcHRzLnN0YXJ0WCwgc3dpcGVPcHRzLnN0YXJ0WSwgc3dpcGVPcHRzLmVuZFgsXG4gICAgICAgIHN3aXBlT3B0cy5lbmRZLCBzd2lwZU9wdHMuZHVyYXRpb24sIHN3aXBlT3B0cy50b3VjaENvdW50LFxuICAgICAgICBzd2lwZU9wdHMuZWxlbWVudCk7XG4gIH1cbiAgbGV0IGFjdGlvbnMgPSBfLm1hcChnZXN0dXJlcywgJ2FjdGlvbicpO1xuXG4gIGlmIChhY3Rpb25zWzBdID09PSAnbG9uZ1ByZXNzJyAmJiBhY3Rpb25zWzFdID09PSAnbW92ZVRvJyAmJiBhY3Rpb25zWzJdID09PSAncmVsZWFzZScpIHtcbiAgICAvLyBzb21lIHRoaW5ncyBhcmUgc3BlY2lhbFxuICAgIHJldHVybiBhd2FpdCB0aGlzLmRvVG91Y2hEcmFnKGdlc3R1cmVzKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoYWN0aW9ucy5sZW5ndGggPT09IDIpIHtcbiAgICAgIC8vIGBwcmVzc2Agd2l0aG91dCBhIHdhaXQgaXMgdG9vIHNsb3cgYW5kIGdldHMgaW50ZXJwcmV0dGVkIGFzIGEgYGxvbmdQcmVzc2BcbiAgICAgIGlmIChfLmhlYWQoYWN0aW9ucykgPT09ICdwcmVzcycgJiYgXy5sYXN0KGFjdGlvbnMpID09PSAncmVsZWFzZScpIHtcbiAgICAgICAgYWN0aW9uc1swXSA9ICd0YXAnO1xuICAgICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPSAndGFwJztcbiAgICAgIH1cblxuICAgICAgLy8gdGhlIGBsb25nUHJlc3NgIGFuZCBgdGFwYCBtZXRob2RzIHJlbGVhc2Ugb24gdGhlaXIgb3duXG4gICAgICBpZiAoKF8uaGVhZChhY3Rpb25zKSA9PT0gJ3RhcCcgfHwgXy5oZWFkKGFjdGlvbnMpID09PSAnbG9uZ1ByZXNzJykgJiYgXy5sYXN0KGFjdGlvbnMpID09PSAncmVsZWFzZScpIHtcbiAgICAgICAgZ2VzdHVyZXMucG9wKCk7XG4gICAgICAgIGFjdGlvbnMucG9wKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGxvbmdwcmVzcyBmb2xsb3dlZCBieSBhbnl0aGluZyBvdGhlciB0aGFuIHJlbGVhc2Ugc2hvdWxkIGJlY29tZSBhIHByZXNzIGFuZCB3YWl0XG4gICAgICBpZiAoYWN0aW9uc1swXSA9PT0gJ2xvbmdQcmVzcycpIHtcbiAgICAgICAgYWN0aW9ucyA9IFsncHJlc3MnLCAnd2FpdCcsIC4uLmFjdGlvbnMuc2xpY2UoMSldO1xuXG4gICAgICAgIGxldCBwcmVzcyA9IGdlc3R1cmVzLnNoaWZ0KCk7XG4gICAgICAgIHByZXNzLmFjdGlvbiA9ICdwcmVzcyc7XG4gICAgICAgIGxldCB3YWl0ID0ge1xuICAgICAgICAgIGFjdGlvbjogJ3dhaXQnLFxuICAgICAgICAgIG9wdGlvbnM6IHttczogcHJlc3Mub3B0aW9ucy5kdXJhdGlvbiB8fCAxMDAwfVxuICAgICAgICB9O1xuICAgICAgICBkZWxldGUgcHJlc3Mub3B0aW9ucy5kdXJhdGlvbjtcbiAgICAgICAgZ2VzdHVyZXMgPSBbcHJlc3MsIHdhaXQsIC4uLmdlc3R1cmVzXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgZml4ZWRHZXN0dXJlcyA9IGF3YWl0IHRoaXMucGFyc2VUb3VjaChnZXN0dXJlcywgZmFsc2UpO1xuICAgIC8vIGZpeCByZWxlYXNlIGFjdGlvbiB0aGVuIHBlcmZvcm0gYWxsIGFjdGlvbnNcbiAgICBpZiAoYWN0aW9uc1thY3Rpb25zLmxlbmd0aCAtIDFdID09PSAncmVsZWFzZScpIHtcbiAgICAgIGFjdGlvbnNbYWN0aW9ucy5sZW5ndGggLSAxXSA9IGF3YWl0IHRoaXMuZml4UmVsZWFzZShnZXN0dXJlcyk7XG4gICAgfVxuICAgIGZvciAobGV0IGcgb2YgZml4ZWRHZXN0dXJlcykge1xuICAgICAgYXdhaXQgdGhpcy5wZXJmb3JtR2VzdHVyZShnKTtcbiAgICB9XG4gIH1cbn07XG5cbmhlbHBlcnMucGFyc2VUb3VjaCA9IGFzeW5jIGZ1bmN0aW9uIHBhcnNlVG91Y2ggKGdlc3R1cmVzLCBtdWx0aSkge1xuICAvLyBiZWNhdXNlIG11bHRpLXRvdWNoIHJlbGVhc2VzIGF0IHRoZSBlbmQgYnkgZGVmYXVsdFxuICBpZiAobXVsdGkgJiYgXy5sYXN0KGdlc3R1cmVzKS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuICAgIGdlc3R1cmVzLnBvcCgpO1xuICB9XG5cbiAgbGV0IHRvdWNoU3RhdGVPYmplY3RzID0gYXdhaXQgYXN5bmNtYXAoZ2VzdHVyZXMsIGFzeW5jIChnZXN0dXJlKSA9PiB7XG4gICAgbGV0IG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnMgfHwge307XG4gICAgaWYgKF8uaW5jbHVkZXMoWydwcmVzcycsICdtb3ZlVG8nLCAndGFwJywgJ2xvbmdQcmVzcyddLCBnZXN0dXJlLmFjdGlvbikpIHtcbiAgICAgIG9wdGlvbnMub2Zmc2V0ID0gZmFsc2U7XG4gICAgICBsZXQgZWxlbWVudElkID0gZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG4gICAgICBpZiAoZWxlbWVudElkKSB7XG4gICAgICAgIGxldCBwb3MgPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGVsZW1lbnRJZCk7XG4gICAgICAgIGlmIChnZXN0dXJlLm9wdGlvbnMueCB8fCBnZXN0dXJlLm9wdGlvbnMueSkge1xuICAgICAgICAgIG9wdGlvbnMueCA9IHBvcy54ICsgKGdlc3R1cmUub3B0aW9ucy54IHx8IDApO1xuICAgICAgICAgIG9wdGlvbnMueSA9IHBvcy55ICsgKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShlbGVtZW50SWQpO1xuICAgICAgICAgIG9wdGlvbnMueCA9IHBvcy54ICsgKHdpZHRoIC8gMik7XG4gICAgICAgICAgb3B0aW9ucy55ID0gcG9zLnkgKyAoaGVpZ2h0IC8gMik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgICAgYWN0aW9uOiBnZXN0dXJlLmFjdGlvbixcbiAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgIHRpbWVPZmZzZXQ6IDAuMDA1LFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdGlvbnMueCA9IChnZXN0dXJlLm9wdGlvbnMueCB8fCAwKTtcbiAgICAgICAgb3B0aW9ucy55ID0gKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuXG4gICAgICAgIGxldCB0b3VjaFN0YXRlT2JqZWN0ID0ge1xuICAgICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICB0aW1lT2Zmc2V0OiAwLjAwNSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRvdWNoU3RhdGVPYmplY3Q7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvZmZzZXQgPSAwLjAwNTtcbiAgICAgIGlmIChnZXN0dXJlLmFjdGlvbiA9PT0gJ3dhaXQnKSB7XG4gICAgICAgIG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnM7XG4gICAgICAgIG9mZnNldCA9IChwYXJzZUludChnZXN0dXJlLm9wdGlvbnMubXMsIDEwKSAvIDEwMDApO1xuICAgICAgfVxuICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgIG9wdGlvbnMsXG4gICAgICAgIHRpbWVPZmZzZXQ6IG9mZnNldCxcbiAgICAgIH07XG4gICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICB9XG4gIH0sIGZhbHNlKTtcbiAgLy8gd2UgbmVlZCB0byBjaGFuZ2UgdGhlIHRpbWUgKHdoaWNoIGlzIG5vdyBhbiBvZmZzZXQpXG4gIC8vIGFuZCB0aGUgcG9zaXRpb24gKHdoaWNoIG1heSBiZSBhbiBvZmZzZXQpXG4gIGxldCBwcmV2UG9zID0gbnVsbCxcbiAgICAgIHRpbWUgPSAwO1xuICBmb3IgKGxldCBzdGF0ZSBvZiB0b3VjaFN0YXRlT2JqZWN0cykge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueCkgJiYgXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpICYmIHByZXZQb3MgIT09IG51bGwpIHtcbiAgICAgIC8vIHRoaXMgaGFwcGVucyB3aXRoIHdhaXRcbiAgICAgIHN0YXRlLm9wdGlvbnMueCA9IHByZXZQb3MueDtcbiAgICAgIHN0YXRlLm9wdGlvbnMueSA9IHByZXZQb3MueTtcbiAgICB9XG4gICAgaWYgKHN0YXRlLm9wdGlvbnMub2Zmc2V0ICYmIHByZXZQb3MpIHtcbiAgICAgIC8vIHRoZSBjdXJyZW50IHBvc2l0aW9uIGlzIGFuIG9mZnNldFxuICAgICAgc3RhdGUub3B0aW9ucy54ICs9IHByZXZQb3MueDtcbiAgICAgIHN0YXRlLm9wdGlvbnMueSArPSBwcmV2UG9zLnk7XG4gICAgfVxuICAgIGRlbGV0ZSBzdGF0ZS5vcHRpb25zLm9mZnNldDtcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiAhXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpKSB7XG4gICAgICBwcmV2UG9zID0gc3RhdGUub3B0aW9ucztcbiAgICB9XG5cbiAgICBpZiAobXVsdGkpIHtcbiAgICAgIGxldCB0aW1lT2Zmc2V0ID0gc3RhdGUudGltZU9mZnNldDtcbiAgICAgIHRpbWUgKz0gdGltZU9mZnNldDtcbiAgICAgIHN0YXRlLnRpbWUgPSBhbmRyb2lkSGVscGVycy50cnVuY2F0ZURlY2ltYWxzKHRpbWUsIDMpO1xuXG4gICAgICAvLyBtdWx0aSBnZXN0dXJlcyByZXF1aXJlICd0b3VjaCcgcmF0aGVyIHRoYW4gJ29wdGlvbnMnXG4gICAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiAhXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpKSB7XG4gICAgICAgIHN0YXRlLnRvdWNoID0ge1xuICAgICAgICAgIHg6IHN0YXRlLm9wdGlvbnMueCxcbiAgICAgICAgICB5OiBzdGF0ZS5vcHRpb25zLnlcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGRlbGV0ZSBzdGF0ZS5vcHRpb25zO1xuICAgIH1cbiAgICBkZWxldGUgc3RhdGUudGltZU9mZnNldDtcbiAgfVxuICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdHM7XG59O1xuXG5cbmNvbW1hbmRzLnBlcmZvcm1NdWx0aUFjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIHBlcmZvcm1NdWx0aUFjdGlvbiAoYWN0aW9ucywgZWxlbWVudElkKSB7XG4gIC8vIEFuZHJvaWQgbmVlZHMgYXQgbGVhc3QgdHdvIGFjdGlvbnMgdG8gYmUgYWJsZSB0byBwZXJmb3JtIGEgbXVsdGkgcG9pbnRlciBnZXN0dXJlXG4gIGlmIChhY3Rpb25zLmxlbmd0aCA9PT0gMSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTXVsdGkgUG9pbnRlciBHZXN0dXJlcyBuZWVkIGF0IGxlYXN0IHR3byBhY3Rpb25zLiAnICtcbiAgICAgICAgJ1VzZSBUb3VjaCBBY3Rpb25zIGZvciBhIHNpbmdsZSBhY3Rpb24uJyk7XG4gIH1cblxuICBjb25zdCBzdGF0ZXMgPSBhd2FpdCBhc3luY21hcChhY3Rpb25zLCBhc3luYyAoYWN0aW9uKSA9PiBhd2FpdCB0aGlzLnBhcnNlVG91Y2goYWN0aW9uLCB0cnVlKSwgZmFsc2UpO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvUGVyZm9ybU11bHRpQWN0aW9uKGVsZW1lbnRJZCwgc3RhdGVzKTtcbn07XG5cbi8qKlxuICogUmVhc29uIGZvciBpc29sYXRpbmcgZG9QZXJmb3JtTXVsdGlBY3Rpb24gZnJvbSBwZXJmb3JtTXVsdGlBY3Rpb24gaXMgZm9yIHJldXNpbmcgcGVyZm9ybU11bHRpQWN0aW9uXG4gKiBhY3Jvc3MgYW5kcm9pZC1kcml2ZXJzIChsaWtlIGFwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyKSBhbmQgdG8gYXZvaWQgY29kZSBkdXBsaWNhdGlvbi5cbiAqIE90aGVyIGFuZHJvaWQtZHJpdmVycyAobGlrZSBhcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlcikgbmVlZCB0byBvdmVycmlkZSBkb1BlcmZvcm1NdWx0aUFjdGlvblxuICogdG8gZmFjaWxpdGF0ZSBwZXJmb3JtTXVsdGlBY3Rpb24uXG4gKi9cbmNvbW1hbmRzLmRvUGVyZm9ybU11bHRpQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gZG9QZXJmb3JtTXVsdGlBY3Rpb24gKGVsZW1lbnRJZCwgc3RhdGVzKSB7XG4gIGxldCBvcHRzO1xuICBpZiAoZWxlbWVudElkKSB7XG4gICAgb3B0cyA9IHtcbiAgICAgIGVsZW1lbnRJZCxcbiAgICAgIGFjdGlvbnM6IHN0YXRlc1xuICAgIH07XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oJ2VsZW1lbnQ6cGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmUnLCBvcHRzKTtcbiAgfSBlbHNlIHtcbiAgICBvcHRzID0ge1xuICAgICAgYWN0aW9uczogc3RhdGVzXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ib290c3RyYXAuc2VuZEFjdGlvbigncGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmUnLCBvcHRzKTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQSxJQUFJQSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0VBQUVDLE9BQU8sR0FBRyxDQUFDLENBQUM7RUFBRUMsVUFBVSxHQUFHLENBQUMsQ0FBQztBQUFDO0FBQUE7QUFFakQsU0FBU0MsZUFBZSxDQUFFQyxHQUFHLEVBQUU7RUFJN0IsT0FBT0MsYUFBSSxDQUFDQyxRQUFRLENBQUNGLEdBQUcsQ0FBQyxHQUFHQSxHQUFHLEdBQUcsR0FBRztBQUN2QztBQUVBLFNBQVNHLHFCQUFxQixDQUFFQyxXQUFXLEVBQUU7RUFHM0MsSUFBSUMsUUFBUSxHQUFHLEdBQUc7RUFDbEIsSUFBSSxPQUFPRCxXQUFXLENBQUNFLE9BQU8sQ0FBQ0MsRUFBRSxLQUFLLFdBQVcsSUFBSUgsV0FBVyxDQUFDRSxPQUFPLENBQUNDLEVBQUUsRUFBRTtJQUMzRUYsUUFBUSxHQUFHRCxXQUFXLENBQUNFLE9BQU8sQ0FBQ0MsRUFBRSxHQUFHLElBQUk7SUFDeEMsSUFBSUYsUUFBUSxLQUFLLENBQUMsRUFBRTtNQUdsQkEsUUFBUSxHQUFH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