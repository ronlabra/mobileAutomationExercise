{"version":3,"file":"logsink.js","names":["logger","patchLogger","npmlog","global","_global_npmlog","level","levels","debug","info","warn","error","colors","npmToWinstonLevels","silly","verbose","http","log","useLocalTimeZone","timestampFormat","format","timestamp","date","Date","valueOf","getTimezoneOffset","toISOString","replace","trim","colorizeFormat","colorize","stripColorFormat","stripColor","code","message","createConsoleTransport","args","logLvl","transports","Console","name","handleExceptions","exitOnError","json","stderrLevels","combine","adjustDebug","logNoColors","printf","printInfo","logTimestamp","createFileTransport","File","filename","logFile","maxFiles","createHttpTransport","host","port","webhook","match","hostAndPort","split","parseInt","Http","path","createTransports","consoleLogLevel","fileLogLevel","loglevel","lvlPair","push","fs","exists","unlink","e","console","init","localTimezone","clear","createLogger","on","logObj","winstonLevel","msg","prefix","magenta","logHandler","_","isFunction","transport","keys","remove","removeAllListeners"],"sources":["../../lib/logsink.js"],"sourcesContent":["import npmlog from 'npmlog';\nimport {createLogger, format, transports} from 'winston';\nimport {fs, logger} from '@appium/support';\nimport _ from 'lodash';\n\n// set up distributed logging before everything else\nlogger.patchLogger(npmlog);\nglobal._global_npmlog = npmlog;\n\n// npmlog is used only for emitting, we use winston for output\nnpmlog.level = 'info';\nconst levels = {\n  debug: 4,\n  info: 3,\n  warn: 2,\n  error: 1,\n};\n\nconst colors = {\n  info: 'cyan',\n  debug: 'grey',\n  warn: 'yellow',\n  error: 'red',\n};\n\nconst npmToWinstonLevels = {\n  silly: 'debug',\n  verbose: 'debug',\n  debug: 'debug',\n  info: 'info',\n  http: 'info',\n  warn: 'warn',\n  error: 'error',\n};\n\nlet log = null;\nlet useLocalTimeZone = false;\n\n// add the timestamp in the correct format to the log info object\nconst timestampFormat = format.timestamp({\n  format() {\n    let date = new Date();\n    if (useLocalTimeZone) {\n      date = new Date(date.valueOf() - date.getTimezoneOffset() * 60000);\n    }\n    // '2012-11-04T14:51:06.157Z' -> '2012-11-04 14:51:06:157'\n    return date.toISOString().replace(/[TZ]/g, ' ').replace(/\\./g, ':').trim();\n  },\n});\n\n// set the custom colors\nconst colorizeFormat = format.colorize({\n  colors,\n});\n\n// Strip the color marking within messages\nconst stripColorFormat = format(function stripColor(info) {\n  const code = /\\u001b\\[(\\d+(;\\d+)*)?m/g; // eslint-disable-line no-control-regex\n  info.message = info.message.replace(code, '');\n  return info;\n})();\n\nfunction createConsoleTransport(args, logLvl) {\n  return new transports.Console({\n    // `name` is unsupported per winston's type declarations\n    // @ts-expect-error\n    name: 'console',\n    handleExceptions: true,\n    exitOnError: false,\n    json: false,\n    level: logLvl,\n    stderrLevels: ['error'],\n    format: format.combine(\n      format(function adjustDebug(info) {\n        // prepend debug marker, and shift to `info` log level\n        if (info.level === 'debug') {\n          info.level = 'info';\n          info.message = `[debug] ${info.message}`;\n        }\n        return info;\n      })(),\n      timestampFormat,\n      args.logNoColors ? stripColorFormat : colorizeFormat,\n      format.printf(function printInfo(info) {\n        return `${args.logTimestamp ? `${info.timestamp} - ` : ''}${info.message}`;\n      })\n    ),\n  });\n}\n\nfunction createFileTransport(args, logLvl) {\n  return new transports.File({\n    // @ts-expect-error\n    name: 'file',\n    filename: args.logFile,\n    maxFiles: 1,\n    handleExceptions: true,\n    exitOnError: false,\n    json: false,\n    level: logLvl,\n    format: format.combine(\n      stripColorFormat,\n      timestampFormat,\n      format.printf(function printInfo(info) {\n        return `${info.timestamp} ${info.message}`;\n      })\n    ),\n  });\n}\n\nfunction createHttpTransport(args, logLvl) {\n  let host = '127.0.0.1';\n  let port = 9003;\n\n  if (args.webhook.match(':')) {\n    const hostAndPort = args.webhook.split(':');\n    host = hostAndPort[0];\n    port = parseInt(hostAndPort[1], 10);\n  }\n\n  return new transports.Http({\n    // @ts-expect-error\n    name: 'http',\n    host,\n    port,\n    path: '/',\n    handleExceptions: true,\n    exitOnError: false,\n    json: false,\n    level: logLvl,\n    format: format.combine(\n      stripColorFormat,\n      format.printf(function printInfo(info) {\n        return `${info.timestamp} ${info.message}`;\n      })\n    ),\n  });\n}\n\nasync function createTransports(args) {\n  let transports = [];\n  let consoleLogLevel = null;\n  let fileLogLevel = null;\n\n  if (args.loglevel && args.loglevel.match(':')) {\n    // --log-level arg can optionally provide diff logging levels for console and file, separated by a colon\n    const lvlPair = args.loglevel.split(':');\n    consoleLogLevel = lvlPair[0] || consoleLogLevel;\n    fileLogLevel = lvlPair[1] || fileLogLevel;\n  } else {\n    consoleLogLevel = fileLogLevel = args.loglevel;\n  }\n\n  transports.push(createConsoleTransport(args, consoleLogLevel));\n\n  if (args.logFile) {\n    try {\n      // if we don't delete the log file, winston will always append and it will grow infinitely large;\n      // winston allows for limiting log file size, but as of 9.2.14 there's a serious bug when using\n      // maxFiles and maxSize together. https://github.com/flatiron/winston/issues/397\n      if (await fs.exists(args.logFile)) {\n        await fs.unlink(args.logFile);\n      }\n\n      transports.push(createFileTransport(args, fileLogLevel));\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.log(\n        `Tried to attach logging to file '${args.logFile}' but an error ` + `occurred: ${e.message}`\n      );\n    }\n  }\n\n  if (args.webhook) {\n    try {\n      transports.push(createHttpTransport(args, fileLogLevel));\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.log(\n        `Tried to attach logging to Http at ${args.webhook} but ` +\n          `an error occurred: ${e.message}`\n      );\n    }\n  }\n\n  return transports;\n}\n\nasync function init(args) {\n  npmlog.level = 'silent';\n  // set de facto param passed to timestamp function\n  useLocalTimeZone = args.localTimezone;\n\n  // clean up in case we have initiated before since npmlog is a global object\n  clear();\n\n  log = createLogger({\n    transports: await createTransports(args),\n    levels,\n  });\n\n  // Capture logs emitted via npmlog and pass them through winston\n  npmlog.on('log', (logObj) => {\n    const winstonLevel = npmToWinstonLevels[logObj.level] || 'info';\n    let msg = logObj.message;\n    if (logObj.prefix) {\n      const prefix = `[${logObj.prefix}]`;\n      msg = `${args.logNoColors ? prefix : prefix.magenta} ${msg}`;\n    }\n    log[winstonLevel](msg);\n    if (args.logHandler && _.isFunction(args.logHandler)) {\n      args.logHandler(logObj.level, msg);\n    }\n  });\n}\n\nfunction clear() {\n  if (log) {\n    for (let transport of _.keys(log.transports)) {\n      log.remove(transport);\n    }\n  }\n  npmlog.removeAllListeners('log');\n}\n\nexport {init, clear};\nexport default init;\n"],"mappings":"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"}